<!DOCTYPE html>
<html lang="en">
<head>
    <title>Geothermieanlagen in Deutschland</title>
    <meta property="og:description" content="Übersichtskarte der Geothermieanlagen in Deutschland" />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css' />
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">
    <script src='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js'></script>
</head>
<body>
<h4>Tiefe Geothermie in Deutschland</h4>
<div id="map">
<nav id="filter-group" class="filter-group"></nav> </div>
<script>
    const filterGroup = document.getElementById('filter-group');
    const map = new maplibregl.Map({
        container: 'map',
        style: 'style.json',
        center: [10.00, 51.50],
        zoom: 3,
        maxBounds: [[3.0, 47.0], [18.0, 56.0]]
    });

    const iconColorMap = {
        'waerme': '#e51626',
        'strom': '#f76d6d',
        'bau': '#025893',
        'planung': '#60bf59',
        'forschung': '#95338a'
    };

    const checkboxLabelMap = {
        'waerme': 'Wärmebereitstellung',
        'strom': 'Stromerzeugung',
        'bau': 'in Bau',
        'planung': 'in Planung',
        'forschung': 'Forschung'
    };

    const loadPlaces = async () => {
        try {
            
            const response = await fetch('places.json');
            const places = await response.json();
            console.log(places); // Verify the structure

            map.addSource('places', {
                'type': 'geojson',
                'data': places
            });

                    // Create and add a title for the checkbox menu
                    const filterTitle = document.createElement('h3'); // or 'h4', depending on the size you prefer
filterTitle.textContent = 'Filter nach Arten der Anlage'; // Set the title text
filterGroup.appendChild(filterTitle); // Add the title to the filter group

            places.features.forEach((feature) => {
                const symbol = feature.properties['icon'];
                const layerID = `poi-${symbol}`;

                if (!map.getLayer(layerID)) {
                    map.addLayer({
                        'id': layerID,
                        'type': 'circle',
                        'source': 'places',
                        'paint': {
                            'circle-color': iconColorMap[symbol],
                            'circle-radius': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                5, 4,
                                10, 12
                            ]
                        },
                        'filter': ['==', 'icon', symbol]
                    });
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = layerID;
                    input.checked = true;
                    filterGroup.appendChild(input);

                    const label = document.createElement('label');
                    label.setAttribute('for', layerID);
                    const customCheckbox = document.createElement('span');
                    customCheckbox.className = 'custom-checkbox';
                    label.appendChild(customCheckbox);
                    label.appendChild(document.createTextNode(checkboxLabelMap[symbol]));

                    const colorIndicator = document.createElement('span');
                    colorIndicator.className = 'color-indicator';
                    colorIndicator.style.backgroundColor = iconColorMap[symbol];
                    label.appendChild(colorIndicator);
                    filterGroup.appendChild(label);

                    input.addEventListener('change', (e) => {
                        map.setLayoutProperty(
                            layerID,
                            'visibility',
                            e.target.checked ? 'visible' : 'none'
                        );
                    });
                }
            });

            // Add popup functionality when a symbol is clicked
            map.on('click', (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: map.getStyle().layers.map(layer => layer.id) });
                if (!features.length || !features[0].properties.title) return;

                const feature = features[0];
                const coordinates = feature.geometry.coordinates.slice();
                
                // Construct the popup content
                const title = feature.properties.title;
                console.log(title);
                const details = feature.properties.details; 
                console.log(details);

                const popupContent = `<strong>${title}</strong><br><ul><li>${details}</li></ul>`; // Create the popup content


                console.log(popupContent);
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                new maplibregl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);
            });

            places.features.forEach((feature) => {
                const symbol = feature.properties['icon'];
                const layerID = `poi-${symbol}`;

                map.on('mouseenter', layerID, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', layerID, () => {
                    map.getCanvas().style.cursor = '';
                });
            });

        } catch (error) {
            console.error('Error loading places data:', error);
        }
    };

    map.on('load', () => {
        loadPlaces();
    });

    map.dragRotate.disable();
    map.touchZoomRotate.disableRotation();
</script>

</body>
</html>
